<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>골프 참석 투표</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f5;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .container {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px 20px 28px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.1);
    }

    h1 {
      font-size: 1.3rem;
      margin: 0 0 12px;
      text-align: center;
    }

    p.description {
      margin: 0 0 20px;
      font-size: 0.9rem;
      color: #6b7280;
      text-align: center;
    }

    form {
      margin-bottom: 20px;
    }

    .field {
      margin-bottom: 12px;
    }

    .field label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #4b5563;
    }

    .field input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
    }

    .option-row {
      display: flex;
      gap: 16px;
      margin-top: 4px;
      font-size: 0.9rem;
    }

    .option-row label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .option-row input[type="radio"] {
      accent-color: #4f46e5;
    }

    button[type="submit"] {
      width: 100%;
      margin-top: 14px;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      background: #4f46e5;
      color: white;
      box-shadow: 0 8px 16px rgba(79, 70, 229, 0.25);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.2s ease;
    }

    button[type="submit"]:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
    }

    button[type="submit"]:active {
      transform: translateY(0);
      box-shadow: 0 5px 12px rgba(79, 70, 229, 0.25);
    }

    button[type="submit"]:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .status {
      font-size: 0.85rem;
      margin-top: 8px;
      color: #6b7280;
      text-align: center;
    }

    .status strong {
      color: #4f46e5;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>골프 참석여부 투표</h1>

    <!-- 투표 폼 영역 -->
    <form id="vote-form">
      <p class="description">
        이름을 입력하시고 참석 / 불참을 선택한 뒤<br />
        <strong>투표하기</strong> 버튼을 눌러 주세요.
      </p>

      <div class="field">
        <label for="username">이름</label>
        <input type="text" id="username" placeholder="예: 박세리" required />
      </div>

      <div class="field">
        <label>참석 여부</label>
        <div class="option-row">
          <label>
            <input type="radio" name="attend" value="참석" />
            참석
          </label>
          <label>
            <input type="radio" name="attend" value="불참" />
            불참
          </label>
        </div>
      </div>

      <button type="submit" id="submit-btn">투표하기</button>
    </form>

    <!-- 상태 메시지 영역 (폼과 별도) -->
    <div class="status" id="status-text">
      아직 투표 전입니다.
    </div>
  </div>

  <script>
    // ★ 본인 Apps Script 웹앱 URL
    const VOTE_API_URL =
      'https://script.google.com/macros/s/AKfycbzOxKKv14jjAajuFpusrA23Niu2ykhbjGG6fcAlfsBqr9-G_0o53Qq8jvnnyIGr19MyYw/exec';

    // 상태 조회용 URL (GET ?status=1)
    const STATUS_API_URL = VOTE_API_URL + '?status=1';

    function getSelectedAttend() {
      const radios = document.querySelectorAll('input[name="attend"]');
      for (const r of radios) {
        if (r.checked) return r.value;
      }
      return null;
    }

    // 폼을 숨기고 "마감/시작 전" 메시지 보여주기
    function showClosedUI(message) {
      const form = document.getElementById('vote-form');
      const status = document.getElementById('status-text');

      form.style.display = 'none';
      status.innerHTML =
        message || '투표가 <strong>마감</strong>되었거나 아직 시작되지 않았습니다.';
    }

    // 서버에 상태만 물어보기
    async function checkStatusOnLoad() {
      try {
        const res = await fetch(STATUS_API_URL, { method: 'GET' });
        const json = await res.json();
        if (!json.ok) return;

        if (json.status !== 'start') {
          // start가 아니면 폼 숨기고 안내만
          showClosedUI('투표가 <strong>마감</strong>되었거나 아직 시작되지 않았습니다.');
        } else {
          // 열려 있으면 기본 문구
          document.getElementById('status-text').textContent = '아직 투표 전입니다.';
        }
      } catch (e) {
        // 상태 조회 실패시에는 폼은 그대로 두고, 상태 문구만 바꿔 둠
        console.error(e);
        document.getElementById('status-text').textContent =
          '서버 상태를 확인하지 못했습니다. 투표 시도 시 다시 확인됩니다.';
      }
    }

    // 투표 내용 서버로 전송
    async function sendVoteToServer(name, attend) {
      const params = new URLSearchParams();
      params.append('name', name);
      params.append('attend', attend);

      const res = await fetch(VOTE_API_URL, {
        method: 'POST',
        body: params
      });

      return res.json(); // { ok: true, status: "start" } 또는 { ok: false, error: "CLOSED", status: ... }
    }

    async function handleSubmit(event) {
      event.preventDefault();

      const form = document.getElementById('vote-form');
      const nameInput = document.getElementById('username');
      const button = document.getElementById('submit-btn');
      const status = document.getElementById('status-text');

      const name = nameInput.value.trim();
      const attend = getSelectedAttend();

      if (!name) {
        alert('이름을 입력해 주세요.');
        nameInput.focus();
        return;
      }
      if (!attend) {
        alert('참석 / 불참 중 하나를 선택해 주세요.');
        return;
      }

      try {
        button.disabled = true;
        status.textContent = '투표를 전송하는 중입니다...';

        const result = await sendVoteToServer(name, attend);

        // 상태가 이미 마감/시작 전인 경우
        if (!result.ok && result.error === 'CLOSED') {
          showClosedUI('투표가 <strong>마감</strong>되었거나 아직 시작되지 않았습니다.');
          return;
        }

        if (!result.ok) {
          throw new Error(result.error || 'SERVER_ERROR');
        }

        // 정상 저장된 경우
        status.innerHTML =
          `<strong>${name}</strong> 님의 선택(<strong>${attend}</strong>)이 저장되었습니다.<br />` +
          '마감 전까지는 수정할 수 있습니다.';

      } catch (e) {
        console.error(e);
        alert('서버에 저장하는 중 문제가 생겼습니다. 잠시 후 다시 시도해 주세요.');
        status.textContent = '오류가 발생했습니다. 다시 시도해 주세요.';
      } finally {
        button.disabled = false;
      }
    }

    // 페이지 로드시 상태 먼저 확인
    window.addEventListener('DOMContentLoaded', () => {
      checkStatusOnLoad();
      document
        .getElementById('vote-form')
        .addEventListener('submit', handleSubmit);
    });
  </script>
</body>
</html>
